<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlowBooth 2.0 - Enhanced</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /**
 * GlowBooth 2.0 - Enhanced Styles
 * Addresses all UX, layout, accessibility, and theming issues
 */

        /* ============================================
   CSS VARIABLES & THEMING
   ============================================ */
        :root {
            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --font-size-base: clamp(14px, 2vw, 16px);
            --font-size-h1: clamp(1.5rem, 4vw, 2rem);
            --font-size-h2: clamp(1.2rem, 3vw, 1.5rem);
            --font-size-button: clamp(1rem, 2.5vw, 1.5rem);
            --font-size-countdown: clamp(4rem, 15vw, 8rem);

            /* Spacing */
            --spacing-xs: clamp(5px, 1vw, 10px);
            --spacing-sm: clamp(10px, 2vw, 15px);
            --spacing-md: clamp(15px, 3vw, 20px);
            --spacing-lg: clamp(20px, 4vw, 30px);
            --spacing-xl: clamp(30px, 5vw, 40px);

            /* Border Radius */
            --border-radius-sm: 5px;
            --border-radius-md: 10px;
            --border-radius-lg: 15px;
            --border-radius-full: 50px;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;

            /* Layout */
            --container-max-width: 1400px;
            --camera-aspect-ratio: 16 / 9;

            /* Polaroid */
            --polaroid-padding: clamp(10px, 2vw, 25px);
            --polaroid-bottom: clamp(40px, 8vw, 100px);
        }

        /* Dark Mode Theme */
        .dark-mode {
            --bg-color: #100018;
            --surface-color: #1a052a;
            --surface-elevated: #2a0a3a;
            --primary-color: #9d00ff;
            --glow-color: #ff1b6b;
            --text-color: #f0f0f0;
            --text-secondary: #b0b0b0;
            --border-color: #3c1a5c;
            --shadow-color: rgba(255, 27, 107, 0.5);
            --shadow-subtle: rgba(0, 0, 0, 0.3);
            --overlay-bg: rgba(16, 0, 24, 0.9);
        }

        /* Light Mode Theme */
        .light-mode {
            --bg-color: #f4f4f9;
            --surface-color: #ffffff;
            --surface-elevated: #fafafa;
            --primary-color: #268bd2;
            --glow-color: #d33682;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #dddddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-subtle: rgba(0, 0, 0, 0.05);
            --overlay-bg: rgba(255, 255, 255, 0.9);
        }

        /* ============================================
   RESET & BASE STYLES
   ============================================ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: var(--font-size-base);
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: var(--spacing-md);
            transition: background-color var(--transition-normal), color var(--transition-normal);
            line-height: 1.6;
        }

        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ============================================
   MAIN CONTAINER
   ============================================ */
        .photobooth-container {
            width: 100%;
            max-width: var(--container-max-width);
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px var(--shadow-color);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* ============================================
   HEADER & THEME TOGGLE
   ============================================ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--surface-elevated);
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-family: var(--font-display);
            font-size: var(--font-size-h1);
            text-shadow: 0 0 10px var(--glow-color);
            margin: 0;
        }

        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .theme-icon {
            font-size: 1.2rem;
            transition: transform var(--transition-fast);
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: var(--transition-normal);
            border-radius: 34px;
            box-shadow: inset 0 2px 4px var(--shadow-subtle);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition-normal);
            border-radius: 50%;
            box-shadow: 0 2px 4px var(--shadow-subtle);
        }

        .theme-switch input:checked+.slider {
            background-color: var(--primary-color);
        }

        .theme-switch input:checked+.slider:before {
            transform: translateX(30px);
        }

        .theme-switch input:focus+.slider {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .theme-switch:hover .slider {
            opacity: 0.9;
        }

        /* ============================================
   MAIN CONTENT LAYOUT
   ============================================ */
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(320px, 100%), 1fr));
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
        }

        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr 1.5fr 1fr;
            }
        }

        .setup-section,
        .booth-section,
        .output-section {
            background: var(--surface-elevated);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            padding: var(--spacing-lg);
            box-shadow: 0 2px 8px var(--shadow-subtle);
        }

        h2 {
            font-family: var(--font-display);
            font-size: var(--font-size-h2);
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--glow-color);
        }

        /* ============================================
   CONTROL GROUPS & OPTIONS
   ============================================ */
        .control-group {
            margin-bottom: var(--spacing-lg);
        }

        .control-group>label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: bold;
            color: var(--text-color);
        }

        .options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .options input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .options label {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            background-color: var(--surface-color);
            color: var(--text-color);
            font-weight: 500;
            user-select: none;
            position: relative;
        }

        .options label:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-subtle);
        }

        .options label:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .options input[type="radio"]:checked+label {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--shadow-color);
            font-weight: bold;
        }

        .options input[type="radio"]:checked+label::before {
            content: "✓ ";
            margin-right: 4px;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }

        fieldset:disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        fieldset:disabled .options label {
            cursor: not-allowed;
        }

        /* ============================================
   CAMERA VIEW
   ============================================ */
        .camera-view {
            position: relative;
            width: 100%;
            aspect-ratio: var(--camera-aspect-ratio);
            background-color: #000;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-bottom: var(--spacing-md);
            border: 3px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            transition: filter var(--transition-normal);
        }

        #canvas {
            display: none;
        }

        /* Camera Overlays */
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flash {
            background-color: white;
            opacity: 0;
        }

        .flash.animate {
            animation: flash-animation 0.5s ease-out;
        }

        @keyframes flash-animation {
            0% {
                opacity: 0.9;
                transform: scale(1.05);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .countdown {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: var(--font-size-countdown);
            color: white;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.8),
                0 0 60px var(--glow-color);
            opacity: 0;
            transform: scale(0.5);
        }

        .countdown.show {
            animation: countdown-pulse 1s forwards;
        }

        @keyframes countdown-pulse {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .camera-error {
            text-align: center;
            padding: var(--spacing-lg);
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .camera-error p:first-child {
            font-size: 3rem;
            margin-bottom: var(--spacing-sm);
        }

        /* ============================================
   PROGRESS BAR
   ============================================ */
        .progress-bar {
            width: 100%;
            background-color: var(--border-color);
            height: 12px;
            border-radius: var(--border-radius-sm);
            margin-top: var(--spacing-md);
            overflow: hidden;
            box-shadow: inset 0 2px 4px var(--shadow-subtle);
        }

        #progress-indicator {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--glow-color));
            transition: width var(--transition-slow);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 0 10px var(--glow-color);
        }

        /* ============================================
   BUTTONS
   ============================================ */
        .action-button {
            width: 100%;
            font-family: var(--font-display);
            font-size: var(--font-size-button);
            color: #fff;
            background: linear-gradient(135deg, var(--glow-color), var(--primary-color));
            border: none;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 4px 15px var(--shadow-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left var(--transition-slow);
        }

        .action-button:hover:not(:disabled)::before {
            left: 100%;
        }

        .action-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .action-button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .action-button:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 3px;
        }

        .action-button:disabled {
            background: linear-gradient(135deg, #555, #777);
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .button-group .action-button {
            flex: 1;
            min-width: 120px;
        }

        /* ============================================
   OUTPUT SECTION
   ============================================ */
        #final-output {
            width: 100%;
            padding: var(--spacing-lg);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-md);
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--spacing-md);
            background-color: var(--surface-color);
            transition: border-color var(--transition-normal);
        }

        #final-output:has(.output-container) {
            border-style: solid;
            border-color: var(--primary-color);
        }

        #final-output>p {
            color: var(--text-secondary);
            font-style: italic;
        }

        .output-container {
            display: grid;
            gap: var(--spacing-md);
            width: 100%;
        }

        .output-container.grid {
            grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 30vw, 200px), 1fr));
        }

        .output-container.strip {
            grid-template-columns: 1fr;
            max-width: min(400px, 100%);
            margin: 0 auto;
        }

        .photo-wrapper {
            background-color: black;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: transform var(--transition-fast);
            position: relative;
        }

        .photo-wrapper:hover {
            transform: scale(1.05) rotate(1deg);
        }

        .photo-wrapper.polaroid {
            background-color: #fff;
            padding: var(--polaroid-padding);
            padding-bottom: var(--polaroid-bottom);
            border-radius: 2px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #ddd;
            transform: rotate(calc(var(--rotation, 0) * 1deg));
        }

        .photo-wrapper.polaroid:hover {
            transform: scale(1.05) rotate(calc(var(--rotation, 0) * 1deg + 2deg));
        }

        .photo-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* ============================================
   RESPONSIVE DESIGN
   ============================================ */
        @media (max-width: 767px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: var(--spacing-sm);
                text-align: center;
            }

            .camera-view {
                aspect-ratio: 4 / 3;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group .action-button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: var(--spacing-xs);
            }

            .photobooth-container {
                border-radius: var(--border-radius-md);
            }

            .main-content {
                padding: var(--spacing-sm);
                gap: var(--spacing-md);
            }

            .setup-section,
            .booth-section,
            .output-section {
                padding: var(--spacing-md);
            }
        }

        /* ============================================
   PRINT STYLES
   ============================================ */
        @media print {
            body {
                background: white;
            }

            .photobooth-container {
                box-shadow: none;
                border: none;
            }

            header,
            .setup-section,
            .booth-section,
            .button-group {
                display: none;
            }

            .output-section {
                border: none;
                box-shadow: none;
            }

            #final-output {
                border: none;
                min-height: auto;
            }
        }

        /* ============================================
   ACCESSIBILITY ENHANCEMENTS
   ============================================ */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .action-button {
                border: 2px solid currentColor;
            }

            .options label {
                border-width: 3px;
            }
        }

        /* Focus visible for keyboard navigation */
        :focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body class="dark-mode">
    <div class="photobooth-container">
        <header>
            <h1>GlowBooth 2.0</h1>
            <div class="theme-switch-wrapper">
                <span class="theme-icon" aria-hidden="true">☀️</span>
                <label class="theme-switch" for="theme-toggle">
                    <span class="sr-only">Toggle between light and dark theme</span>
                    <input type="checkbox" id="theme-toggle" checked aria-label="Theme toggle">
                    <span class="slider" role="presentation"></span>
                </label>
                <span class="theme-icon" aria-hidden="true">🌙</span>
            </div>
        </header>

        <main class="main-content">
            <!-- Setup Section -->
            <section class="setup-section" aria-labelledby="setup-heading">
                <h2 id="setup-heading">1. Setup</h2>
                <fieldset id="setup-fieldset">
                    <legend class="sr-only">Photo session configuration</legend>

                    <div class="control-group">
                        <label id="photo-count-label">Photos per Session:</label>
                        <div class="options" role="radiogroup" aria-labelledby="photo-count-label">
                            <input type="radio" id="count1" name="photo-count" value="1">
                            <label for="count1" tabindex="0">
                                <span class="option-text">1</span>
                                <span class="sr-only">photo</span>
                            </label>

                            <input type="radio" id="count2" name="photo-count" value="2">
                            <label for="count2" tabindex="0">
                                <span class="option-text">2</span>
                                <span class="sr-only">photos</span>
                            </label>

                            <input type="radio" id="count3" name="photo-count" value="3">
                            <label for="count3" tabindex="0">
                                <span class="option-text">3</span>
                                <span class="sr-only">photos</span>
                            </label>

                            <input type="radio" id="count4" name="photo-count" value="4" checked>
                            <label for="count4" tabindex="0">
                                <span class="option-text">4</span>
                                <span class="sr-only">photos</span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group">
                        <label id="layout-label">Layout Style:</label>
                        <div class="options" role="radiogroup" aria-labelledby="layout-label">
                            <input type="radio" id="layout-grid" name="layout" value="grid" checked>
                            <label for="layout-grid" tabindex="0">
                                <span class="option-text">Grid</span>
                            </label>

                            <input type="radio" id="layout-strip" name="layout" value="strip">
                            <label for="layout-strip" tabindex="0">
                                <span class="option-text">Strip</span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group">
                        <label id="effect-label">Photo Effect:</label>
                        <div class="options" role="radiogroup" aria-labelledby="effect-label">
                            <input type="radio" id="effect-none" name="effect" value="none" checked>
                            <label for="effect-none" tabindex="0">
                                <span class="option-text">Standard</span>
                            </label>

                            <input type="radio" id="effect-polaroid" name="effect" value="polaroid">
                            <label for="effect-polaroid" tabindex="0">
                                <span class="option-text">Polaroid</span>
                            </label>
                        </div>
                    </div>

                    <div class="control-group">
                        <label id="filter-label">Live Filter (Preview):</label>
                        <div class="options" role="radiogroup" aria-labelledby="filter-label">
                            <input type="radio" id="filter-none" name="filter" value="none" checked>
                            <label for="filter-none" tabindex="0">
                                <span class="option-text">None</span>
                            </label>

                            <input type="radio" id="filter-sepia" name="filter" value="sepia(1)">
                            <label for="filter-sepia" tabindex="0">
                                <span class="option-text">Sepia</span>
                            </label>

                            <input type="radio" id="filter-bw" name="filter" value="grayscale(1)">
                            <label for="filter-bw" tabindex="0">
                                <span class="option-text">B&W</span>
                            </label>

                            <input type="radio" id="filter-vibrant" name="filter" value="saturate(2) contrast(1.2)">
                            <label for="filter-vibrant" tabindex="0">
                                <span class="option-text">Vibrant</span>
                            </label>
                        </div>
                    </div>
                </fieldset>
            </section>

            <!-- Camera Booth Section -->
            <section class="booth-section" aria-labelledby="booth-heading">
                <h2 id="booth-heading">2. Capture</h2>
                <div class="camera-view" role="region" aria-label="Camera preview">
                    <video id="video" autoplay playsinline aria-label="Live webcam feed"></video>
                    <canvas id="canvas" aria-hidden="true"></canvas>
                    <div class="camera-overlay flash" id="flash" aria-hidden="true"></div>
                    <div class="camera-overlay countdown" id="countdown" role="status" aria-live="assertive"
                        aria-atomic="true"></div>
                    <div class="camera-error" id="camera-error" style="display: none;" role="alert">
                        <p aria-hidden="true">🎥</p>
                        <p>Could not access webcam. Please check permissions and refresh.</p>
                    </div>
                </div>

                <button id="main-action-btn" class="action-button" aria-label="Start photo session">
                    Start Session
                </button>

                <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
                    aria-label="Session progress">
                    <div id="progress-indicator"></div>
                </div>
            </section>

            <!-- Output Section -->
            <section class="output-section" aria-labelledby="output-heading">
                <h2 id="output-heading">3. Result</h2>
                <div id="final-output" aria-live="polite" role="region" aria-label="Final photo output">
                    <p>Your photo creation will appear here!</p>
                </div>
                <div class="button-group">
                    <button id="download-btn" class="action-button" disabled aria-label="Download final image">
                        Download
                    </button>
                    <button id="share-btn" class="action-button" disabled aria-label="Share final image">
                        Share
                    </button>
                    <button id="retake-btn" class="action-button" disabled aria-label="Retake last photo"
                        style="display: none;">
                        Retake Last
                    </button>
                </div>
            </section>
        </main>
    </div>

    <audio id="shutter-sound"
        src="data:audio/mpeg;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhJAEAAAD//wD/APMA9QD1APMA8gDyAPMA8gDzAPMA9ADzAPMA8wDzAO8A8ADuAO4A7gDtAOwA7QDqAOsA6ADpAOYA5QDMAa4BigGMAbABsQGvAbQBswG3AbgBuwG9AcABwAHCAcMBxAHIAcsBzQHPAdEB0wHYAdwB4AHjAfEB8gH0AfkB/gIAAgQDCAQaBDwETAR8BIgElATsBSAFOAVcBYgFqAXMBdQF6AX8BhQGMAZABlwGgAaUBqwGvAbYBvAHAAccBzQHTAdgB3wHlAfYCAwIGAhQCHQImAi8CSQJOAl8CbQJ/AocCkAKbAqECqQKyArsCwwLFAs8C1wLeAvUC/wMMgxCDFIMcgyQDJ4MyAzqDP4NAg0qDWoNjg2wDdIN9g4yDmYOlg6yDsoO+g8WDywPaA+ED5wPzA/sEBAQcBGQEcAR4BIIEjASyBNoE+gUGBSEFKwVCBVoFYAWMBbUFzAXfBesGAQYUBiEGNQZNBlUGYwZ5BoMGmAavBr0GywbqBv0HFAchBywHQAdQB1sHcwfIB/8IPAjBCLoI4wj3CSQJLQlDCVwJaQlxCYkJkQmoCb8JygnbCfQKAwoMCi0KRgpVCmIKaAqBCqMKwArlCvwLJQszDEEMVwx4DIkMrQzcDOcM/A0EDRQNKA1HDV0Ngg2VDbcN7A4ADiAORw5aDogOzA7jDwwPNg9GD18Pag9/D5cPrw/JD+8QBhATEB8QKhA0EDoQPhBFEE4QWxBcEGIQahBwEHcQhxCUEJkQoBClEKwQthC+EMcQ0BDhEO0RChEeESoRTBFaEWwRjBGeEagRyBHUEewSBhIaEiYSUhJuEn4SihKaEsYS3hMIDQ=="
        preload="auto"></audio>

    <script>
        /**
 * GlowBooth 2.0 - Enhanced Application
 * Modular architecture addressing all critique points
 */

        // ============================================
        // CONFIGURATION MODULE
        // ============================================
        const CONFIG = {
            COUNTDOWN_SECONDS: 3,
            PHOTO_WIDTH: 800,
            PHOTO_HEIGHT: 600,
            DOWNLOAD_PADDING: 40,
            MAX_CANVAS_SIZE: 4096, // Prevent memory issues
            JPEG_QUALITY: 0.92,
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const Utils = {
            /**
             * Query selector with error handling
             */
            $(selector, parent = document) {
                const element = parent.querySelector(selector);
                if (!element) {
                    console.warn(`Element not found: ${selector}`);
                }
                return element;
            },

            /**
             * Query all with array return
             */
            $$(selector, parent = document) {
                return Array.from(parent.querySelectorAll(selector));
            },

            /**
             * Debounce function for performance
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            /**
             * Create a promise-based delay
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            /**
             * Load image as promise
             */
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            },

            /**
             * Calculate optimal canvas dimensions
             */
            calculateCanvasDimensions(itemCount, layout, itemWidth, itemHeight, padding) {
                const cols = layout === 'grid' ? Math.ceil(Math.sqrt(itemCount)) : 1;
                const rows = layout === 'grid' ? Math.ceil(itemCount / cols) : itemCount;

                const width = (itemWidth * cols) + (padding * (cols + 1));
                const height = (itemHeight * rows) + (padding * (rows + 1));

                // Prevent memory issues by capping canvas size
                const scale = Math.min(1, CONFIG.MAX_CANVAS_SIZE / Math.max(width, height));

                return {
                    width: Math.floor(width * scale),
                    height: Math.floor(height * scale),
                    scale,
                    cols,
                    rows
                };
            },

            /**
             * Generate random rotation for polaroid effect
             */
            getRandomRotation() {
                return (Math.random() - 0.5) * 6; // -3 to +3 degrees
            }
        };

        // ============================================
        // CAMERA MODULE
        // ============================================
        class Camera {
            constructor() {
                this.video = Utils.$('#video');
                this.canvas = Utils.$('#canvas');
                this.errorElement = Utils.$('#camera-error');
                this.stream = null;
                this.currentFilter = 'none';
            }

            async initialize() {
                try {
                    if (this.stream) {
                        this.stop();
                    }

                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });

                    this.video.srcObject = this.stream;
                    this.errorElement.style.display = 'none';
                    return true;
                } catch (error) {
                    console.error('Camera initialization error:', error);
                    this.errorElement.style.display = 'block';
                    return false;
                }
            }

            stop() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }

            applyFilter(filter) {
                this.currentFilter = filter;
                this.video.style.filter = filter;
            }

            async captureFrame() {
                return new Promise((resolve) => {
                    const context = this.canvas.getContext('2d', { alpha: false });

                    // Set canvas size to video dimensions
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;

                    // Reset transform to avoid stacking
                    context.setTransform(1, 0, 0, 1, 0, 0);

                    // Flip horizontally to un-mirror
                    context.translate(this.canvas.width, 0);
                    context.scale(-1, 1);

                    // Apply filter
                    context.filter = this.currentFilter;
                    context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);

                    // Reset filter
                    context.filter = 'none';

                    // Convert to data URL
                    const dataUrl = this.canvas.toDataURL('image/jpeg', CONFIG.JPEG_QUALITY);
                    resolve(dataUrl);
                });
            }
        }

        // ============================================
        // SESSION MANAGER MODULE
        // ============================================
        class SessionManager {
            constructor() {
                this.isActive = false;
                this.photos = [];
                this.currentCount = 0;
                this.targetCount = 4;
                this.settings = {
                    layout: 'grid',
                    effect: 'none',
                    filter: 'none'
                };
            }

            start(settings) {
                this.isActive = true;
                this.photos = [];
                this.currentCount = 0;
                this.settings = { ...settings };
                this.targetCount = settings.photoCount;
            }

            addPhoto(dataUrl) {
                this.photos.push(dataUrl);
                this.currentCount++;
            }

            removeLastPhoto() {
                if (this.photos.length > 0) {
                    this.photos.pop();
                    this.currentCount--;
                }
            }

            isComplete() {
                return this.currentCount >= this.targetCount;
            }

            end() {
                this.isActive = false;
            }

            getProgress() {
                return (this.currentCount / this.targetCount) * 100;
            }

            reset() {
                this.isActive = false;
                this.photos = [];
                this.currentCount = 0;
            }
        }

        // ============================================
        // COUNTDOWN MODULE
        // ============================================
        class Countdown {
            constructor(element) {
                this.element = element;
                this.isRunning = false;
            }

            async run(seconds) {
                this.isRunning = true;

                for (let i = seconds; i > 0; i--) {
                    if (!this.isRunning) break;

                    this.element.textContent = i;
                    this.element.classList.add('show');

                    // Announce for screen readers
                    this.element.setAttribute('aria-label', `${i} seconds remaining`);

                    await Utils.delay(800);
                    this.element.classList.remove('show');
                    await Utils.delay(200);
                }

                this.isRunning = false;
            }

            cancel() {
                this.isRunning = false;
                this.element.classList.remove('show');
                this.element.textContent = '';
            }
        }

        // ============================================
        // RENDERER MODULE
        // ============================================
        class Renderer {
            constructor(outputElement) {
                this.outputElement = outputElement;
            }

            clear() {
                this.outputElement.innerHTML = '<p>Your photo creation will appear here!</p>';
            }

            async render(photos, settings) {
                this.outputElement.innerHTML = '';

                const container = document.createElement('div');
                container.className = `output-container ${settings.layout}`;

                for (let i = 0; i < photos.length; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = `photo-wrapper ${settings.effect}`;

                    // Add random rotation for polaroid effect
                    if (settings.effect === 'polaroid') {
                        const rotation = Utils.getRandomRotation();
                        wrapper.style.setProperty('--rotation', rotation);
                    }

                    const img = document.createElement('img');
                    img.src = photos[i];
                    img.alt = `Photo ${i + 1} of ${photos.length}`;
                    img.loading = 'lazy';

                    wrapper.appendChild(img);
                    container.appendChild(wrapper);
                }

                this.outputElement.appendChild(container);
            }
        }

        // ============================================
        // DOWNLOAD MANAGER MODULE
        // ============================================
        class DownloadManager {
            constructor(session) {
                this.session = session;
            }

            async generate(forSharing = false) {
                const { photos, settings } = this.session;
                const isDarkMode = document.body.classList.contains('dark-mode');

                // Load all images
                const images = await Promise.all(photos.map(src => Utils.loadImage(src)));

                // Calculate dimensions
                const isPolaroid = settings.effect === 'polaroid';
                const polaroidPadding = isPolaroid ? 25 : 0;
                const polaroidBottom = isPolaroid ? 100 : 0;

                const itemWidth = CONFIG.PHOTO_WIDTH + (polaroidPadding * 2);
                const itemHeight = CONFIG.PHOTO_HEIGHT + polaroidPadding * 2 + polaroidBottom;

                const dimensions = Utils.calculateCanvasDimensions(
                    images.length,
                    settings.layout,
                    itemWidth,
                    itemHeight,
                    CONFIG.DOWNLOAD_PADDING
                );

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = dimensions.width;
                canvas.height = dimensions.height;

                const ctx = canvas.getContext('2d', { alpha: false });

                // Background
                ctx.fillStyle = isDarkMode ? '#100018' : '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw images
                const scaledPadding = CONFIG.DOWNLOAD_PADDING * dimensions.scale;
                const scaledItemWidth = itemWidth * dimensions.scale;
                const scaledItemHeight = itemHeight * dimensions.scale;
                const scaledPhotoWidth = CONFIG.PHOTO_WIDTH * dimensions.scale;
                const scaledPhotoHeight = CONFIG.PHOTO_HEIGHT * dimensions.scale;
                const scaledPolaroidPadding = polaroidPadding * dimensions.scale;

                for (let i = 0; i < images.length; i++) {
                    const row = settings.layout === 'grid' ? Math.floor(i / dimensions.cols) : i;
                    const col = settings.layout === 'grid' ? i % dimensions.cols : 0;

                    const x = (col * scaledItemWidth) + ((col + 1) * scaledPadding);
                    const y = (row * scaledItemHeight) + ((row + 1) * scaledPadding);

                    if (isPolaroid) {
                        // Draw polaroid frame
                        ctx.fillStyle = '#FFFFFF';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                        ctx.shadowBlur = 20 * dimensions.scale;
                        ctx.shadowOffsetX = 2 * dimensions.scale;
                        ctx.shadowOffsetY = 2 * dimensions.scale;
                        ctx.fillRect(x, y, scaledItemWidth, scaledItemHeight);
                        ctx.shadowColor = 'transparent';

                        // Draw photo
                        ctx.drawImage(
                            images[i],
                            x + scaledPolaroidPadding,
                            y + scaledPolaroidPadding,
                            scaledPhotoWidth,
                            scaledPhotoHeight
                        );
                    } else {
                        ctx.drawImage(images[i], x, y, scaledPhotoWidth, scaledPhotoHeight);
                    }
                }

                // Convert to blob
                return new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        resolve({ blob, canvas });
                    }, 'image/jpeg', CONFIG.JPEG_QUALITY);
                });
            }

            async download() {
                const { blob } = await this.generate(false);
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `GlowBooth_${Date.now()}.jpg`;
                link.click();
                URL.revokeObjectURL(url);
            }

            async share() {
                const { blob } = await this.generate(true);
                const file = new File([blob], 'glowbooth.jpg', { type: 'image/jpeg' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'My GlowBooth Creation!',
                            text: 'Check out this photo I took with GlowBooth 2.0!',
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Share failed:', error);
                            // Fallback to download
                            await this.download();
                        }
                    }
                } else {
                    // Fallback to download if sharing not supported
                    await this.download();
                }
            }
        }

        // ============================================
        // UI CONTROLLER MODULE
        // ============================================
        class UIController {
            constructor() {
                this.elements = {
                    mainButton: Utils.$('#main-action-btn'),
                    downloadButton: Utils.$('#download-btn'),
                    shareButton: Utils.$('#share-btn'),
                    retakeButton: Utils.$('#retake-btn'),
                    setupFieldset: Utils.$('#setup-fieldset'),
                    progressIndicator: Utils.$('#progress-indicator'),
                    progressBar: Utils.$('.progress-bar'),
                    flash: Utils.$('#flash'),
                    shutterSound: Utils.$('#shutter-sound'),
                };
            }

            updateMainButton(text, disabled = false) {
                this.elements.mainButton.textContent = text;
                this.elements.mainButton.disabled = disabled;
                this.elements.mainButton.setAttribute('aria-label', text);
            }

            updateProgress(percentage) {
                this.elements.progressIndicator.style.width = `${percentage}%`;
                this.elements.progressBar.setAttribute('aria-valuenow', Math.round(percentage));
            }

            enableSetup(enabled) {
                this.elements.setupFieldset.disabled = !enabled;
            }

            enableDownloadButtons(enabled) {
                this.elements.downloadButton.disabled = !enabled;

                // Only enable share if Web Share API is available
                const canShare = 'share' in navigator;
                this.elements.shareButton.disabled = !enabled || !canShare;

                if (!canShare) {
                    this.elements.shareButton.title = 'Sharing not supported in this browser';
                }
            }

            enableRetakeButton(enabled) {
                this.elements.retakeButton.disabled = !enabled;
                this.elements.retakeButton.style.display = enabled ? 'block' : 'none';
            }

            async playShutter() {
                try {
                    this.elements.shutterSound.currentTime = 0;
                    await this.elements.shutterSound.play();
                } catch (error) {
                    console.warn('Could not play shutter sound:', error);
                }
            }

            triggerFlash() {
                this.elements.flash.classList.add('animate');
                setTimeout(() => {
                    this.elements.flash.classList.remove('animate');
                }, 500);
            }

            getSettings() {
                return {
                    photoCount: parseInt(Utils.$('input[name="photo-count"]:checked').value),
                    layout: Utils.$('input[name="layout"]:checked').value,
                    effect: Utils.$('input[name="effect"]:checked').value,
                    filter: Utils.$('input[name="filter"]:checked').value,
                };
            }
        }

        // ============================================
        // THEME MANAGER MODULE
        // ============================================
        class ThemeManager {
            constructor() {
                this.toggle = Utils.$('#theme-toggle');
                this.init();
            }

            init() {
                // Check for saved preference or system preference
                const savedTheme = localStorage.getItem('glowbooth-theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
                    this.setLightMode();
                } else {
                    this.setDarkMode();
                }

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('glowbooth-theme')) {
                        e.matches ? this.setDarkMode() : this.setLightMode();
                    }
                });
            }

            setDarkMode() {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                this.toggle.checked = true;
                localStorage.setItem('glowbooth-theme', 'dark');
            }

            setLightMode() {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                this.toggle.checked = false;
                localStorage.setItem('glowbooth-theme', 'light');
            }

            toggle() {
                if (document.body.classList.contains('dark-mode')) {
                    this.setLightMode();
                } else {
                    this.setDarkMode();
                }
            }
        }

        // ============================================
        // KEYBOARD NAVIGATION MODULE
        // ============================================
        class KeyboardNavigation {
            constructor() {
                this.init();
            }

            init() {
                // Make radio button labels keyboard accessible
                Utils.$$('.options label').forEach(label => {
                    label.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            const input = Utils.$(`#${label.getAttribute('for')}`);
                            if (input && !input.disabled) {
                                input.checked = true;
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    });
                });

                // Arrow key navigation for radio groups
                Utils.$$('.options').forEach(group => {
                    const labels = Utils.$$('label', group);
                    labels.forEach((label, index) => {
                        label.addEventListener('keydown', (e) => {
                            let nextIndex = -1;

                            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                                e.preventDefault();
                                nextIndex = (index + 1) % labels.length;
                            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                                e.preventDefault();
                                nextIndex = (index - 1 + labels.length) % labels.length;
                            }

                            if (nextIndex !== -1) {
                                labels[nextIndex].focus();
                            }
                        });
                    });
                });
            }
        }

        // ============================================
        // MAIN APPLICATION
        // ============================================
        class GlowBoothApp {
            constructor() {
                this.camera = new Camera();
                this.session = new SessionManager();
                this.countdown = new Countdown(Utils.$('#countdown'));
                this.renderer = new Renderer(Utils.$('#final-output'));
                this.downloadManager = new DownloadManager(this.session);
                this.ui = new UIController();
                this.themeManager = new ThemeManager();
                this.keyboardNav = new KeyboardNavigation();

                this.isCapturing = false;
            }

            async init() {
                // Initialize camera
                const cameraReady = await this.camera.initialize();

                if (!cameraReady) {
                    this.ui.updateMainButton('Camera Unavailable', true);
                    return;
                }

                // Register event listeners
                this.registerEventListeners();

                console.log('GlowBooth 2.0 initialized successfully!');
            }

            registerEventListeners() {
                // Main action button
                this.ui.elements.mainButton.addEventListener('click', () => this.handleMainAction());

                // Download and share buttons
                this.ui.elements.downloadButton.addEventListener('click', () => this.handleDownload());
                this.ui.elements.shareButton.addEventListener('click', () => this.handleShare());

                // Retake button
                this.ui.elements.retakeButton.addEventListener('click', () => this.handleRetake());

                // Theme toggle
                this.themeManager.toggle.addEventListener('change', () => this.themeManager.toggle());

                // Filter changes
                this.ui.elements.setupFieldset.addEventListener('change', (e) => {
                    if (e.target.name === 'filter') {
                        this.camera.applyFilter(e.target.value);
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Space or Enter to trigger main button (when focused)
                    if ((e.key === ' ' || e.key === 'Enter') &&
                        document.activeElement === this.ui.elements.mainButton &&
                        !this.ui.elements.mainButton.disabled) {
                        e.preventDefault();
                        this.handleMainAction();
                    }
                });
            }

            async handleMainAction() {
                if (this.isCapturing) return;

                if (!this.session.isActive) {
                    this.startSession();
                } else {
                    await this.capturePhoto();
                }
            }

            startSession() {
                const settings = this.ui.getSettings();
                this.session.start(settings);

                // Update UI
                this.ui.enableSetup(false);
                this.ui.enableDownloadButtons(false);
                this.ui.enableRetakeButton(false);
                this.renderer.clear();
                this.ui.updateProgress(0);

                // Apply filter
                this.camera.applyFilter(settings.filter);

                // Start first capture
                this.capturePhoto();
            }

            async capturePhoto() {
                if (this.isCapturing) return;

                this.isCapturing = true;
                this.ui.updateMainButton('Get Ready...', true);

                // Run countdown
                await this.countdown.run(CONFIG.COUNTDOWN_SECONDS);

                // Capture
                this.ui.playShutter();
                this.ui.triggerFlash();

                const photoData = await this.camera.captureFrame();
                this.session.addPhoto(photoData);

                // Update progress
                this.ui.updateProgress(this.session.getProgress());

                // Check if session complete
                if (this.session.isComplete()) {
                    await this.endSession();
                } else {
                    const nextPhoto = this.session.currentCount + 1;
                    this.ui.updateMainButton(
                        `Take Photo ${nextPhoto} of ${this.session.targetCount}`,
                        false
                    );
                    this.ui.enableRetakeButton(true);
                }

                this.isCapturing = false;
            }

            async endSession() {
                this.session.end();

                // Render final output
                await this.renderer.render(this.session.photos, this.session.settings);

                // Update UI
                this.ui.updateMainButton('Start New Session', false);
                this.ui.enableSetup(true);
                this.ui.enableDownloadButtons(true);
                this.ui.enableRetakeButton(false);

                // Announce completion for screen readers
                const announcement = document.createElement('div');
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.textContent = `Photo session complete! ${this.session.photos.length} photos captured.`;
                announcement.style.position = 'absolute';
                announcement.style.left = '-10000px';
                document.body.appendChild(announcement);
                setTimeout(() => announcement.remove(), 1000);
            }

            handleRetake() {
                if (this.session.currentCount > 0) {
                    this.session.removeLastPhoto();
                    this.ui.updateProgress(this.session.getProgress());

                    const nextPhoto = this.session.currentCount + 1;
                    this.ui.updateMainButton(
                        `Take Photo ${nextPhoto} of ${this.session.targetCount}`,
                        false
                    );

                    if (this.session.currentCount === 0) {
                        this.ui.enableRetakeButton(false);
                    }
                }
            }

            async handleDownload() {
                this.ui.elements.downloadButton.disabled = true;
                this.ui.elements.downloadButton.textContent = 'Preparing...';

                try {
                    await this.downloadManager.download();
                    this.ui.elements.downloadButton.textContent = 'Download';
                } catch (error) {
                    console.error('Download failed:', error);
                    alert('Failed to download image. Please try again.');
                    this.ui.elements.downloadButton.textContent = 'Download';
                } finally {
                    this.ui.elements.downloadButton.disabled = false;
                }
            }

            async handleShare() {
                this.ui.elements.shareButton.disabled = true;
                this.ui.elements.shareButton.textContent = 'Preparing...';

                try {
                    await this.downloadManager.share();
                    this.ui.elements.shareButton.textContent = 'Share';
                } catch (error) {
                    console.error('Share failed:', error);
                    this.ui.elements.shareButton.textContent = 'Share';
                } finally {
                    this.ui.elements.shareButton.disabled = false;
                }
            }
        }

        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const app = new GlowBoothApp();
            app.init();
        });
    </script>
</body>

</html> 